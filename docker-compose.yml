services:
  # ClickHouse - Log Storage
  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    container_name: lognog-clickhouse
    ports:
      - "8123:8123"  # HTTP interface (internal services connect via docker network)
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ./clickhouse/init:/docker-entrypoint-initdb.d
    environment:
      CLICKHOUSE_DB: lognog
      CLICKHOUSE_USER: lognog
      CLICKHOUSE_PASSWORD: lognog123
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lognog-network

  # Vector - Log Ingestion
  vector:
    image: timberio/vector:0.35.0-alpine
    container_name: lognog-vector
    command: ["--config", "/etc/vector/vector.toml"]
    ports:
      - "514:514/udp"   # Syslog UDP
      - "514:514/tcp"   # Syslog TCP
      - "8686:8686"     # Vector API
    volumes:
      - ./vector/vector.toml:/etc/vector/vector.toml:ro
      - vector-data:/var/lib/vector
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker logs collection
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - lognog-network

  # Node.js API
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: lognog-api
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 8123
      CLICKHOUSE_USER: lognog
      CLICKHOUSE_PASSWORD: lognog123
      CLICKHOUSE_DATABASE: lognog
      SQLITE_PATH: /data/lognog.db
      JWT_SECRET: ${JWT_SECRET:-lognog-jwt-secret-change-me}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-lognog-refresh-secret-change-me}
      OTLP_REQUIRE_AUTH: ${OTLP_REQUIRE_AUTH:-true}
      GEOIP_DATA_PATH: /data/geoip
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-deepseek-coder-v2:16b}
      OLLAMA_REASONING_MODEL: ${OLLAMA_REASONING_MODEL:-qwen3:30b}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENROUTER_MODEL: ${OPENROUTER_MODEL:-anthropic/claude-3.5-sonnet}
      LLAMAINDEX_PERSIST_DIR: /data/llamaindex
    volumes:
      - api-data:/data
      - geoip-data:/data/geoip
      - llamaindex-data:/data/llamaindex
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lognog-network

  # React UI
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: lognog-ui
    # No external port - accessed via nginx reverse proxy
    depends_on:
      api:
        condition: service_healthy
    networks:
      - lognog-network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: lognog-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api
      - ui
    networks:
      - lognog-network

  # Log Generator (for testing)
  log-generator:
    build:
      context: ./log-generator
      dockerfile: Dockerfile
    container_name: lognog-log-generator
    environment:
      SYSLOG_HOST: vector
      SYSLOG_PORT: 514
      SYSLOG_PROTOCOL: udp
      LOG_RATE: 10
      VERBOSE: "false"
    depends_on:
      - vector
    networks:
      - lognog-network
    profiles:
      - testing

  # Cloudflare Tunnel - Expose LogNog to the internet securely
  # No port forwarding needed, no firewall changes
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: lognog-cloudflared
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    restart: unless-stopped
    depends_on:
      - nginx
    networks:
      - lognog-network
    profiles:
      - tunnel

  # Ollama - Local AI (GPU)
  ollama:
    image: ollama/ollama:latest
    container_name: lognog-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - lognog-network
    profiles:
      - ai

networks:
  lognog-network:
    driver: bridge

volumes:
  clickhouse-data:
  vector-data:
  api-data:
  geoip-data:
  ollama-data:
  llamaindex-data:
